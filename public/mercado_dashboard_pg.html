<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard de Pedidos - Mercado Guarar√° (Postgres)</title>
    <link rel="icon" type="image/png" href="./images/favicon_midilabs.png" />
    <link href="./style.css" rel="stylesheet" />

    <!-- Charts + PDF -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  </head>

  <body>
    <h1>üìä Dashboard de Pedidos - Mercado Guarar√°</h1>
    <p class="hint">
      Vers√£o Postgres. Este HTML <b>n√£o</b> conecta direto no banco (por seguran√ßa). Ele consome uma API HTTP do seu
      servidor (Node/Express) que l√™ as tabelas <code>meg_pedido</code> e <code>meg_pedido_item</code>.
    </p>

    <div class="buttons">
      <button id="btnRefresh" class="primary">üîÑ Atualizar do Banco</button>
      <button id="btnTheme" class="secondary">üåó Tema Claro/Escuro</button>
      <button id="btnPDFItens" class="secondary">üì¶ PDF - Lista de Compras</button>
      <span id="connStatus" class="status-pill">API: n√£o verificado</span>
    </div>

    <div class="controls">
      <div>
        <label>Data de In√≠cio</label>
        <input type="date" id="dateStart" />
      </div>
      <div>
        <label>Data de Fim</label>
        <input type="date" id="dateEnd" />
      </div>
      <div>
        <label>Pedido</label>
        <select id="pedidoFilter">
          <option value="">Todos</option>
        </select>
      </div>
      <div>
        <label>Status</label>
        <select id="statusFilter">
          <option value="">Todos</option>
        </select>
      </div>
      <div>
        <label>Cliente</label>
        <select id="clientFilter">
          <option value="">Todos</option>
        </select>
      </div>
      <div>
        <label>Produto</label>
        <select id="productFilter">
          <option value="">Todos</option>
        </select>
      </div>
    </div>

    <div class="kpis">
      <div class="card">
        <div class="kpi-title">Total de Pedidos</div>
        <div class="kpi-value" id="kpiPedidos">0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Clientes Ativos</div>
        <div class="kpi-value" id="kpiClientes">0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Faturamento (R$)</div>
        <div class="kpi-value" id="kpiFaturamento">0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Itens Vendidos</div>
        <div class="kpi-value" id="kpiItens">0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Ticket M√©dio (R$)</div>
        <div class="kpi-value" id="kpiTicket">0</div>
      </div>
    </div>

    <div class="card">
      <h3>Evolu√ß√£o de Pedidos e Faturamento</h3>
      <canvas id="timeChart"></canvas>
    </div>
    <div class="card">
      <h3>Distribui√ß√£o por Status</h3>
      <canvas id="statusChart"></canvas>
    </div>
    <div class="card">
      <h3>Top Produtos</h3>
      <canvas id="prodChart"></canvas>
    </div>
    <div class="card">
      <h3>Top Clientes</h3>
      <canvas id="clientChart"></canvas>
    </div>

    <div class="card">
      <h3>Pedidos</h3>
      <p class="note">Dica: use os filtros acima e clique em ‚ÄúAtualizar do Banco‚Äù.</p>
      <table id="tblPedidos">
        <thead>
          <tr>
            <th>Data</th>
            <th>ID</th>
            <th>Cliente</th>
            <th>Total</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Itens</h3>
      <table id="tblItens">
        <thead>
          <tr>
            <th>Data</th>
            <th>Pedido</th>
            <th>Produto</th>
            <th>Pre√ßo</th>
            <th>Qtd</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      // =====================
      // Config
      // =====================
      // Ajuste aqui se sua API estiver em outro host/porta.
      // - ""  => mesma origem (recomendado se voc√™ servir este HTML pelo mesmo servidor)
      // - "https://seu-dominio" => host externo
      const API_BASE = "";

      // =====================
      // Estado
      // =====================
      let TB_PEDIDO = [];
      let TB_ITEM = [];

      const fmt = (n) =>
        (Number(n) || 0).toLocaleString("pt-BR", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });

      const parseD = (s) => (s ? new Date(s) : null);

      const pedidoFilter = document.getElementById("pedidoFilter");
      const statusFilter = document.getElementById("statusFilter");
      const clientFilter = document.getElementById("clientFilter");
      const productFilter = document.getElementById("productFilter");
      const connStatus = document.getElementById("connStatus");

      let timeChart, statusChart, prodChart, clientChart;

      // =====================
      // UI actions
      // =====================
      document.getElementById("btnTheme").onclick = () => document.body.classList.toggle("light");

      document.getElementById("btnRefresh").onclick = async () => {
        await fetchDataFromAPI();
        initFilters();
        // se o usu√°rio ainda n√£o escolheu datas, tenta preencher
        autoSetDateRange();
        applyFilters();
      };

      ["dateStart", "dateEnd", "statusFilter", "clientFilter", "productFilter", "pedidoFilter"].forEach((id) =>
        document.getElementById(id).addEventListener("change", () => {
          // filtros mudaram: recarrega do banco (mais fiel) e reaplica
          // (se quiser modo offline, troque por: applyFilters())
          fetchDataFromAPI().then(() => {
            initFilters();
            applyFilters();
          });
        })
      );

      // Carrega automaticamente ao abrir
      (async function boot() {
        // pr√©-preenche datas com √∫ltimos 30 dias (se vazio)
        const today = new Date();
        const start = new Date();
        start.setDate(today.getDate() - 30);

        const pad = (n) => String(n).padStart(2, "0");
        const toI = (d) => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;

        const dsEl = document.getElementById("dateStart");
        const deEl = document.getElementById("dateEnd");
        if (!dsEl.value) dsEl.value = toI(start);
        if (!deEl.value) deEl.value = toI(today);

        await fetchDataFromAPI();
        initFilters();
        applyFilters();
      })();

      // =====================
      // API
      // =====================
      async function fetchDataFromAPI() {
        const ds = document.getElementById("dateStart").value;
        const de = document.getElementById("dateEnd").value;

        const params = new URLSearchParams();
        if (ds) params.set("dateStart", ds);
        if (de) params.set("dateEnd", de);

        const pid = pedidoFilter.value;
        const st = statusFilter.value;
        const cl = (clientFilter.value || "").split("/")[0];
        const pr = productFilter.value;

        if (pid) params.set("pedidoId", pid);
        if (st) params.set("status", st);
        if (cl) params.set("cliente", cl);
        if (pr) params.set("produto", pr);

        try {
          connStatus.textContent = "API: consultando...";
          const resp = await fetch(`${API_BASE}/api/meg/dashboard?${params.toString()}`, {
            headers: { Accept: "application/json" },
          });

          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(`HTTP ${resp.status} - ${text}`);
          }

          const data = await resp.json();
          TB_PEDIDO = Array.isArray(data.pedidos) ? data.pedidos : [];
          TB_ITEM = Array.isArray(data.itens) ? data.itens : [];

          connStatus.textContent = `API: ok (${TB_PEDIDO.length} pedidos)`;
          connStatus.style.opacity = 1;
        } catch (err) {
          console.error(err);
          connStatus.textContent = "API: erro";
          alert(
            "N√£o consegui consultar a API do dashboard.\n\n" +
              "Checklist:\n" +
              "1) Seu servidor Node est√° rodando?\n" +
              "2) Existe a rota GET /api/meg/dashboard?\n" +
              "3) CORS (se host diferente) e firewall ok?\n\n" +
              "Detalhe: " +
              (err?.message || err)
          );
        }
      }

      // =====================
      // Filtros
      // =====================
      function autoSetDateRange() {
        // se j√° est√° preenchido, n√£o mexe
        const dsEl = document.getElementById("dateStart");
        const deEl = document.getElementById("dateEnd");
        if (dsEl.value && deEl.value) return;

        const dates = TB_PEDIDO.map((p) => new Date(p.data || p.DATA)).filter((d) => !isNaN(d));
        if (!dates.length) return;
        dates.sort((a, b) => a - b);

        const pad = (n) => String(n).padStart(2, "0");
        const toI = (d) => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
        dsEl.value = toI(dates[0]);
        deEl.value = toI(dates[dates.length - 1]);
      }

      function initFilters() {
        pedidoFilter.innerHTML = '<option value="">Todos</option>';
        statusFilter.innerHTML = '<option value="">Todos</option>';
        clientFilter.innerHTML = '<option value="">Todos</option>';
        productFilter.innerHTML = '<option value="">Todos</option>';

        const sSet = new Set();
        const cSet = new Set();
        const pSet = new Set();
        const idSet = new Set();

        TB_PEDIDO.forEach((p) => {
          const STATUS = p.status ?? p.STATUS;
          const ID = p.id ?? p.ID;
          const CLIENTE = p.cliente ?? p.CLIENTE;
          const NOME = p.nome ?? p.NOME;

          if (STATUS) sSet.add(STATUS);
          if (CLIENTE) cSet.add(`${CLIENTE}/${NOME || ""}`);
          if (ID != null) idSet.add(String(ID));
        });

        TB_ITEM.forEach((i) => {
          const PRODUTO = i.produto ?? i.PRODUTO;
          if (PRODUTO) pSet.add(PRODUTO);
        });

        [...idSet].sort((a, b) => Number(a) - Number(b)).forEach((v) => {
          const o = document.createElement("option");
          o.value = v;
          o.text = v;
          pedidoFilter.appendChild(o);
        });

        [...sSet].sort().forEach((v) => {
          const o = document.createElement("option");
          o.value = v;
          o.text = v;
          statusFilter.appendChild(o);
        });

        [...cSet].sort().forEach((v) => {
          const o = document.createElement("option");
          o.value = v;
          o.text = v;
          clientFilter.appendChild(o);
        });

        [...pSet].sort().forEach((v) => {
          const o = document.createElement("option");
          o.value = v;
          o.text = v;
          productFilter.appendChild(o);
        });
      }

      // =====================
      // Aplicar filtros (frontend)
      // =====================
      function applyFilters() {
        const pid = pedidoFilter.value;
        const ds = document.getElementById("dateStart").value ? new Date(document.getElementById("dateStart").value) : null;
        const de = document.getElementById("dateEnd").value ? new Date(document.getElementById("dateEnd").value) : null;
        const st = statusFilter.value;
        const cl = (clientFilter.value || "").split("/")[0];
        const pr = productFilter.value;

        let pedidos;
        if (pid) {
          pedidos = TB_PEDIDO.filter((p) => String(p.id ?? p.ID) === String(pid));
        } else {
          pedidos = TB_PEDIDO.filter((p) => {
            const d = parseD(p.data ?? p.DATA);
            const STATUS = p.status ?? p.STATUS;
            const CLIENTE = p.cliente ?? p.CLIENTE;

            const deEnd = de ? new Date(de.getFullYear(), de.getMonth(), de.getDate(), 23, 59, 59) : null;
            return (
              (!ds || (d && d >= ds)) &&
              (!deEnd || (d && d <= deEnd)) &&
              (!st || STATUS === st) &&
              (!cl || CLIENTE === cl)
            );
          });
        }

        const ids = new Set(pedidos.map((p) => String(p.id ?? p.ID)));
        let itens = TB_ITEM.filter((i) => ids.has(String(i.pedido_id ?? i.PEDIDO_ID ?? i.pedidoId)) && (!pr || (i.produto ?? i.PRODUTO) === pr));
        itens = itens.sort((a, b) => String(a.produto ? a.PRODUTO : "").localeCompare(String(b.produto ? b.PRODUTO : "")));

        renderKPIs(pedidos, itens);
        renderTables(pedidos, itens);
        renderCharts(pedidos, itens);
        window.filtered = { pedidos, itens };
      }

      // =====================
      // Render
      // =====================
      function renderKPIs(pedidos, itens) {
        document.getElementById("kpiPedidos").textContent = pedidos.length;
        document.getElementById("kpiClientes").textContent = new Set(pedidos.map((p) => p.cliente ?? p.CLIENTE)).size;

        const fat = pedidos.reduce((s, p) => s + Number(p.total ? p.TOTAL : 0), 0);
        document.getElementById("kpiFaturamento").textContent = fmt(fat);

        const qtd = itens.reduce((s, i) => s + Number(i.quantidade ? i.QUANTIDADE : 0), 0);
        document.getElementById("kpiItens").textContent = String(qtd);

        document.getElementById("kpiTicket").textContent = fmt(pedidos.length ? fat / pedidos.length : 0);
      }

      function renderTables(pedidos, itens) {
        const tp = document.querySelector("#tblPedidos tbody");
        tp.innerHTML = pedidos
          .map((p) => {
            const d = new Date(p.data ?? p.DATA);
            return `<tr><td>${isNaN(d) ? "" : d.toLocaleDateString("pt-BR")}</td><td>${p.id ?? p.ID}</td><td>${p.cliente ?? p.CLIENTE} (${p.nome ? p.NOME : ""})</td><td>${fmt(p.total ? p.TOTAL : 0)}</td><td>${p.status ?? p.STATUS}</td></tr>`;
          })
          .join("");

        const ti = document.querySelector("#tblItens tbody");
        ti.innerHTML = itens
          .map((i) => {
            const d = new Date(i.data ?? i.DATA);
            return `<tr><td>${isNaN(d) ? "" : d.toLocaleDateString("pt-BR")}</td><td>${i.pedido_id ?? i.PEDIDO_ID ?? ""}</td><td>${i.produto ?? i.PRODUTO}</td><td style='text-align:right'>${fmt(i.preco ? i.PRECO : 0)}</td><td>${i.quantidade ?? i.QUANTIDADE}</td><td>${i.status ?? i.STATUS}</td></tr>`;
          })
          .join("");
      }

      function renderCharts(pedidos, itens) {
        const byDate = {};
        pedidos.forEach((p) => {
          const d0 = new Date(p.data ?? p.DATA);
          if (isNaN(d0)) return;
          const d = d0.toISOString().slice(0, 10);
          if (!byDate[d]) byDate[d] = { o: 0, r: 0 };
          byDate[d].o++;
          byDate[d].r += Number(p.total ? p.TOTAL : 0);
        });

        const labels = Object.keys(byDate).sort();
        const o = labels.map((d) => byDate[d].o);
        const r = labels.map((d) => byDate[d].r);

        const bySt = {};
        pedidos.forEach((p) => {
          const st = p.status ?? p.STATUS;
          bySt[st] = (bySt[st] || 0) + 1;
        });

        const byProd = {};
        itens.forEach((i) => {
          const prod = i.produto ?? i.PRODUTO;
          byProd[prod] = (byProd[prod] || 0) + Number(i.quantidade ? i.QUANTIDADE : 0);
        });

        const topP = Object.entries(byProd)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        const byCli = {};
        pedidos.forEach((p) => {
          const cli = p.cliente ?? p.CLIENTE;
          byCli[cli] = (byCli[cli] || 0) + Number(p.total ? p.TOTAL : 0);
        });

        const topC = Object.entries(byCli)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);

        [timeChart, statusChart, prodChart, clientChart].forEach((c) => c && c.destroy());

        timeChart = new Chart(document.getElementById("timeChart"), {
          type: "bar",
          data: {
            labels,
            datasets: [
              { label: "Pedidos", data: o },
              { label: "Faturamento (R$)", data: r, type: "line", yAxisID: "y1" },
            ],
          },
          options: {
            scales: {
              y: { beginAtZero: true },
              y1: { beginAtZero: true, position: "right" },
            },
          },
        });

        statusChart = new Chart(document.getElementById("statusChart"), {
          type: "doughnut",
          data: { labels: Object.keys(bySt), datasets: [{ data: Object.values(bySt) }] },
        });

        prodChart = new Chart(document.getElementById("prodChart"), {
          type: "bar",
          data: {
            labels: topP.map((e) => e[0]),
            datasets: [{ label: "Qtd", data: topP.map((e) => e[1]) }],
          },
          options: { indexAxis: "y" },
        });

        clientChart = new Chart(document.getElementById("clientChart"), {
          type: "bar",
          data: {
            labels: topC.map((e) => e[0]),
            datasets: [{ label: "Faturamento (R$)", data: topC.map((e) => e[1]) }],
          },
          options: { indexAxis: "y" },
        });
      }

      // =====================
      // PDF
      // =====================
      document.getElementById("btnPDFItens").onclick = () => {
        if (!window.filtered || window.filtered.pedidos.length === 0) {
          alert("Nenhum pedido encontrado para gerar o PDF.");
          return;
        }

        const pedidos = window.filtered.pedidos;
        const itens = window.filtered.itens;
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();

        pedidos.forEach((pedido, idx) => {
          if (idx > 0) pdf.addPage();

          const pedidoId = pedido.id ?? pedido.ID;
          const cliente = pedido.cliente ?? pedido.CLIENTE;
          const nome = pedido.nome ?? pedido.NOME;
          const endereco = pedido.endereco ?? pedido.ENDERECO;
          const total = pedido.total ?? pedido.TOTAL;
          const data = pedido.data ?? pedido.DATA;
          const status = pedido.status ?? pedido.STATUS;

          pdf.setFontSize(14);
          pdf.setFont(undefined, "bold");
          pdf.text(`Pedido: ${pedidoId}`, 10, 15);

          pdf.setFontSize(11);
          pdf.setFont(undefined, "normal");
          pdf.text(`Cliente: ${cliente} - (${nome || ""})`, 10, 25);
          pdf.text(`Data: ${data ? new Date(data).toLocaleDateString("pt-BR") : ""}`, 10, 32);
          pdf.text(`Status: ${status || ""}`, 10, 39);
          pdf.text(`Endere√ßo: ${endereco || "N√£o informado"}`, 10, 46);
          pdf.text(`Total do Pedido: R$ ${Number(total || 0).toFixed(2)}`, 10, 53);

          pdf.setFillColor(200, 200, 200);
          pdf.rect(10, 60, 190, 8, "F");
          pdf.setTextColor(0, 0, 0);
          pdf.setFontSize(11);
          pdf.setFont(undefined, "bold");
          pdf.text("PRODUTO", 12, 65);
          pdf.text("QTD.", 150, 65);
          pdf.text("R$ UNIT√ÅRIO", 200, 65, null, null, "right");

          let y = 73;
          let toggle = false;

          const itensPedido = itens.filter((i) => String(i.pedido_id ?? i.PEDIDO_ID) === String(pedidoId));

          itensPedido.forEach((i) => {
            if (toggle) {
              pdf.setFillColor(240, 240, 240);
              pdf.rect(10, y - 5, 190, 8, "F");
            }
            toggle = !toggle;

            pdf.setTextColor(0, 0, 0);
            pdf.setFont(undefined, "normal");

            pdf.text(String(i.produto ?? i.PRODUTO), 12, y);
            pdf.text(String(i.quantidade ?? i.QUANTIDADE), 150, y);
            pdf.text(`R$ ${Number(i.preco ? i.PRECO : 0).toFixed(2)}`, 200, y, null, null, "right");

            y += 8;
            if (y > 270) {
              pdf.addPage();
              y = 20;
              toggle = false;
            }
          });
        });

        pdf.save("lista_compras.pdf");
      };
    </script>
  </body>
</html>
